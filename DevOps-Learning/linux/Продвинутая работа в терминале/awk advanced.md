## ![](https://ucarecdn.stepik.net/0b43f187-baac-4f17-8e25-e1c32df1cfee/)

## Утилита awk — расширенные возможности

В прошлом уроке мы изучили основы работы с **awk**, научились выбирать и выводить поля, фильтровать строки и использовать простые команды форматирования. Теперь рассмотрим более мощные и продвинутые возможности awk, которые позволят вам эффективно решать сложные задачи обработки данных.

### Что рассмотрим в этом уроке:

- Использование переменных и выражений
- Условия и управляющие конструкции (if, else)
- Циклы (for, while)
- Создание и использование массивов.`count[$1]++` нужно использовать вместе с циклом `for(word in count) print word, count[word]`, иначе результата не будет.
- Функции awk и написание собственных

### Использование переменных

В awk вы можете создавать собственные переменные прямо внутри команды и использовать их в вычислениях.

**Пример**: подсчёт суммы значений столбца.

Есть файл `sales.txt`:

```nginx
Apples 10
Oranges 5
Bananas 8
```

Подсчитаем сумму чисел из второго поля:

```nginx
awk '{sum += $2} END {print "Итого:", sum}' sales.txt
```

Вывод:

```makefile
Итого: 23
```

- `sum += $2` — накопление суммы
- `END` — блок выполняется после обработки всех строк

### Условия (if, else)


**Пример**: вывести продукты, продажи которых больше 7:

```nginx
awk '{if ($2 > 7) print $1, "— продано:", $2}' sales.txt
```

Результат:

```nginx
Apples — продано: 10
Bananas — продано: 8
```

Можно использовать расширенный вариант с else:

```swift
awk '{if ($2 > 7) 
          print $1, "хорошо продаётся";
      else 
          print $1, "плохо продаётся"}' sales.txt
```

### Циклы в awk

awk поддерживает циклы (for и while), которые позволяют выполнять повторяющиеся действия.

#### Цикл for

**Пример**: вывести квадраты чисел от 1 до 5.

```rust
awk 'BEGIN {for (i=1; i<=5; i++) print i, "в квадрате =", i*i}'
```

Вывод:

```undefined
1 в квадрате = 1
2 в квадрате = 4
3 в квадрате = 9
4 в квадрате = 16
5 в квадрате = 25
```

- `BEGIN` — блок, выполняющийся до начала обработки строк файла (удобно для инициализации).

#### Цикл while

Вывести числа от 5 до 1 с помощью цикла while:

```rust
awk 'BEGIN {i=5; while(i>0){print i; i--}}'
```

Вывод:

```undefined
5
4
3
2
1
```

### Работа с массивами

В awk массивы позволяют эффективно хранить и обрабатывать данные.

#### Пример: подсчёт повторяющихся слов

Есть файл `words.txt`:

```nginx
apple
banana
apple
banana
orange
apple
```

Посчитаем, сколько раз каждое слово встречается:

```applescript
awk '{count[$1]++} END {for(word in count) print word, count[word]}' words.txt
```

Результат:

```nginx
apple 3
banana 2
orange 1
```

- `count[$1]++` — массив count, где ключом является слово, а значением — количество повторений
- `for(word in count)` — цикл, перебирающий все ключи массива

### Встроенные функции awk

awk имеет набор полезных встроенных функций для работы со строками и числами:

- `length(str)` — длина строки
- `substr(str, start, length)` — часть строки
- `tolower(str)`, `toupper(str)` — перевод строки в нижний или верхний регистр
- `int(num)` — округление числа вниз до целого

> Функция `int(num)` возвращает целое число (отбрасывает дробную часть).  
> Функция `substr(str,1,3)` возвращает первые 3 символа строки.

**Пример:** вывести первые три символа каждого слова в верхнем регистре:

```nginx
awk '{print toupper(substr($1,1,3))}' words.txt
```

Вывод:

```nginx
APP
BAN
APP
BAN
ORA
APP
```

### Создание собственных функций

Вы можете определить собственные функции прямо в awk-команде. Например, функция для нахождения максимума из двух чисел:

```swift
awk 'function max(a,b){return (a > b) ? a : b}
     {print "Максимум из", $2, "и 5 — это", max($2,5)}' sales.txt
```

Если в `sales.txt` содержится число продаж, получим такой вывод:

```1c
Максимум из 10 и 5 — это 10
Максимум из 5 и 5 — это 5
Максимум из 8 и 5 — это 8
```

## Краткая шпаргалка по расширенным возможностям awk

- `{sum+=$2} END {print sum}` — подсчёт суммы поля
- `if ($2 > 10) print $1` — условия для фильтрации строк
- `for (i=1; i<=10; i++)` — цикл for
- `count[$1]++` — массивы для подсчёта повторов
- `function имя(a,b){return a+b}` — создание пользовательских функций
- `count[$1]++` и `for(word in count) print word, count[word]` — подсчёт слов
    
- `$1+$2 > 100` — условие для суммы полей
    

## Итог

**awk** — это не просто утилита для вывода полей, а мощный текстовый процессор с поддержкой переменных, циклов, условий, массивов и функций. Эти возможности позволяют вам автоматизировать сложные задачи обработки и анализа данных непосредственно в командной строке.

В следующем уроке вы сможете потренироваться в использовании awk на практике, применяя полученные знания для решения реальных задач.