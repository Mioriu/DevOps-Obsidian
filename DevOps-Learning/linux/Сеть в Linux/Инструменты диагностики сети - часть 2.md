В предыдущем уроке мы рассмотрели базовые инструменты диагностики сети в Linux. Теперь перейдём к более продвинутым утилитам, которые позволяют глубже анализировать сетевой трафик, измерять производительность соединений и выявлять сложные проблемы в сети.

### Анализ пакетов с помощью tcpdump

`tcpdump` — это мощный инструмент командной строки для захвата и анализа сетевых пакетов. Он позволяет видеть сетевой трафик на низком уровне, что бесценно для диагностики сложных проблем и изучения сетевых протоколов.

**Почему tcpdump полезен:**

- Позволяет увидеть реальные данные, передаваемые по сети
- Помогает выявить неправильную конфигурацию протоколов
- Показывает, почему соединение не устанавливается или разрывается
- Даёт возможность обнаружить подозрительную активность в сети

**Базовое использование:**

```bash
sudo tcpdump -i eth0
```

Эта команда показывает все пакеты, проходящие через интерфейс eth0. Вывод может быть очень объёмным, поэтому обычно используют фильтры для ограничения количества отображаемых пакетов.

**Полезные опции tcpdump:**

- `-n` — не преобразовывать IP-адреса в имена хостов:
    
    ```bash
    sudo tcpdump -i eth0 -n
    ```
    
    Это ускоряет работу и избавляет от задержек, связанных с DNS-запросами.
- `-c` — ограничение количества пакетов:
    
    ```bash
    sudo tcpdump -i eth0 -c 10
    ```
    
    Эта команда покажет только первые 10 пакетов и завершится.
- `-A` — вывод содержимого пакетов в ASCII:
    
    ```css
    sudo tcpdump -i eth0 -A port 80
    ```
    
    Полезно для просмотра содержимого HTTP-трафика.
- `-w` — сохранение пакетов в файл для последующего анализа:
    
    ```bash
    sudo tcpdump -i eth0 -w capture.pcap
    ```
    
    Сохранённый файл можно потом открыть в Wireshark для более удобного анализа.

**Фильтрация пакетов:**

Фильтры позволяют сосредоточиться только на интересующем трафике:

- **По хосту:**
    
    ```nginx
    sudo tcpdump -i eth0 host 192.168.1.100
    ```
    
    Показывает только пакеты, отправленные на или полученные от указанного IP-адреса.
- **По порту:**
    
    ```bash
    sudo tcpdump -i eth0 port 80
    ```
    
    Отображает только HTTP-трафик (порт 80).
- **По типу протокола:**
    
    ```bash
    sudo tcpdump -i eth0 icmp
    ```
    
    Показывает только ICMP-пакеты (ping и некоторые сообщения об ошибках).
- **Сложные фильтры с операторами:**
    
    ```bash
    sudo tcpdump -i eth0 'tcp port 80 and host 192.168.1.100'
    ```
    
    Показывает только HTTP-трафик с указанным хостом.
- **Направление трафика:**
    
    ```css
    sudo tcpdump -i eth0 src 192.168.1.100
    sudo tcpdump -i eth0 dst port 443
    ```
    
    Фильтрация по источнику (src) или назначению (dst).

**Интерпретация вывода tcpdump:**

Вывод tcpdump для каждого пакета обычно включает:

- Временную метку
- Протокол (TCP, UDP, ICMP, ...)
- Источник и назначение (IP-адреса и порты)
- Флаги TCP (SYN, ACK, FIN, ...)
- Номер последовательности и подтверждения для TCP
- Размер окна и пакета

Пример вывода для HTTP-запроса:

```yaml
12:45:32.740051 IP 192.168.1.100.52314 > 93.184.216.34.80: Flags [S], seq 1020702983, win 64240, options [mss 1460,sackOK,TS val 3717911290 ecr 0,nop,wscale 7], length 0
```

Здесь мы видим пакет SYN (начало TCP-соединения) от 192.168.1.100 (порт 52314) к серверу 93.184.216.34 (порт 80) с определёнными параметрами соединения.

**Совет:** Изучение tcpdump требует времени. Начните с простых фильтров и постепенно переходите к более сложным. Сохраняйте интересные сессии в файлы .pcap для дальнейшего анализа в Wireshark.

### Базовые принципы использования Wireshark

Wireshark — это графический анализатор протоколов с гораздо более удобным интерфейсом, чем tcpdump. Он предоставляет наглядное представление сетевого трафика и мощные возможности для его анализа.

**Установка Wireshark:**

```bash
# Ubuntu/Debian
sudo apt install wireshark

# CentOS/RHEL/Fedora
sudo dnf install wireshark
```

При установке вам будет предложено разрешить обычным пользователям захватывать пакеты. В целях безопасности рекомендуется ответить "Нет" и запускать Wireshark от имени root при необходимости.

**Основные возможности Wireshark:**

1. **Захват трафика в реальном времени** с любого доступного интерфейса
2. **Раскрашивание пакетов** по типу протокола для быстрой визуальной идентификации
3. **Фильтрация пакетов** с использованием мощного языка фильтров
4. **Детальная расшифровка пакетов** с разбором по полям протоколов
5. **Статистика и графики** для анализа характеристик трафика
6. **Отслеживание TCP-потоков** для просмотра полных сеансов связи

**Базовый рабочий процесс с Wireshark:**

1. **Запуск:**
    
    ```bash
    sudo wireshark
    ```
    
2. **Выбор интерфейса:** В главном окне дважды щёлкните по интерфейсу, с которого хотите захватывать трафик (eth0, wlan0 и т.д.)
3. **Применение фильтра захвата:** Перед началом захвата можно ввести фильтр в поле "Capture Filter", например:
    
    ```nginx
    host 192.168.1.100 and port 80
    ```
    
4. **Остановка захвата:** Нажмите кнопку "Stop" в верхней панели инструментов, когда захватили достаточно пакетов
5. **Фильтрация вывода:** В поле "Display Filter" можно вводить фильтры для уже захваченных пакетов:
    
    ```python
    http or dns
    ```
    
    Это покажет только HTTP и DNS пакеты.
6. **Анализ пакетов:** Щёлкните по пакету для просмотра его деталей в нижней панели. Здесь вы увидите разбор по полям протоколов.

**Полезные функции Wireshark:**

- **Отслеживание TCP-потоков:** Правый клик на TCP-пакете → "Follow TCP Stream" позволяет увидеть весь обмен данными в рамках соединения
- **Статистика:** Меню "Statistics" предлагает различные графики и отчёты, такие как распределение протоколов, таблицы завершения TCP-соединений и т.д.
- **Анализ задержек:** Инструменты "IO Graphs" показывают графики активности по времени
- **Экспорт пакетов:** Можно сохранить отфильтрованные пакеты или конкретные данные из них

**Примеры полезных фильтров отображения:**

- `ip.addr == 192.168.1.100` — пакеты, связанные с указанным IP
- `http.request` — только HTTP-запросы
- `tcp.flags.syn == 1` — пакеты TCP SYN (установление соединения)
- `tcp.analysis.retransmission` — повторные передачи TCP (признак проблем)
- `dns.qry.name contains "example.com"` — DNS-запросы, содержащие указанный домен

Wireshark особенно полезен для сложной диагностики, когда нужно детально рассмотреть обмен данными между приложениями или выявить сетевые аномалии.

### Мониторинг использования сети с помощью iftop, nethogs

Для наблюдения за тем, какие хосты и приложения потребляют сетевой трафик, используются специализированные инструменты мониторинга.

#### 1. Утилита iftop

`iftop` показывает, какие хосты генерируют наибольший объем трафика в сети. Это помогает быстро выявить, какое соединение потребляет пропускную способность.

**Установка:**

```bash
# Ubuntu/Debian
sudo apt install iftop

# CentOS/RHEL/Fedora
sudo dnf install iftop
```

**Базовое использование:**

```bash
sudo iftop -i eth0
```

Интерфейс `iftop` показывает в реальном времени:

- Пары хостов, между которыми идёт обмен данными
- Скорость соединения в обоих направлениях (↓ и ↑)
- Накопленный объём переданных данных
- Общую статистику использования канала

**Полезные опции iftop:**

- `-n` — отключить преобразование IP-адресов в имена хостов:
    
    ```bash
    sudo iftop -i eth0 -n
    ```
    
- `-P` — показывать порты:
    
    ```css
    sudo iftop -i eth0 -P
    ```
    
    Помогает идентифицировать протоколы по номерам портов.
- `-F` — фильтрация трафика (использует синтаксис pcap, как в tcpdump):
    
    ```bash
    sudo iftop -i eth0 -F "port 80 or port 443"
    ```
    
    Показывает только HTTP и HTTPS трафик.

**Интерактивные команды в iftop:** Во время работы iftop можно использовать клавиши для изменения отображения:  
- `p` — показать/скрыть порты  
- `s` — показать/скрыть исходные хосты  
- `d` — показать/скрыть хосты назначения  
- `t` — переключить между текстовым и графическим режимом отображения  
- `l` — включить/выключить отображение шкалы  
- `q` — выход из программы

#### 2. Утилита nethogs

В то время как `iftop` показывает трафик по хостам, `nethogs` группирует трафик по процессам. Это очень полезно для определения, какое приложение потребляет сетевой канал.

**Установка:**

```bash
# Ubuntu/Debian
sudo apt install nethogs

# CentOS/RHEL/Fedora
sudo dnf install nethogs
```

**Базовое использование:**

```bash
sudo nethogs eth0
```

Интерфейс `nethogs` показывает:

- Процессы, использующие сеть (PID и имя)
- Скорость отправки и получения данных для каждого процесса
- Общий объём отправленных и полученных данных

**Полезные опции nethogs:**

- `-d` — интервал обновления в секундах:
    
    ```bash
    sudo nethogs -d 2 eth0
    ```
    
    Обновляет данные каждые 2 секунды вместо стандартной 1 секунды.
- `-v` — уровень детализации (0-2):
    
    ```bash
    sudo nethogs -v 2 eth0
    ```
    
    Увеличивает количество отображаемой информации.

**Интерактивные команды в nethogs:**

- `m` — переключение режима сортировки (по скорости отправки, получения, общей)
- `r` — сортировка в обратном порядке
- `s` — переключение между отображением скорости и общего трафика
- `q` — выход из программы

Сочетание `iftop` и `nethogs` даёт полную картину использования сети: с кем общается система и какие программы это делают.

### Тестирование пропускной способности с помощью iperf

Когда нужно измерить реальную пропускную способность сети между двумя хостами, `iperf` становится незаменимым инструментом. Он позволяет проводить тесты производительности TCP и UDP соединений.

**Установка:**

```bash
# Ubuntu/Debian
sudo apt install iperf

# CentOS/RHEL/Fedora
sudo dnf install iperf
```

В современных дистрибутивах часто доступна обновлённая версия — iperf3:

```bash
# Ubuntu/Debian
sudo apt install iperf3

# CentOS/RHEL/Fedora
sudo dnf install iperf3
```

**Принцип работы:**

Для проведения теста необходимо запустить `iperf` в режиме сервера на одном хосте и в режиме клиента на другом. Клиент соединяется с сервером и начинает передачу данных для измерения пропускной способности.

**Базовое использование:**

1. Запустите сервер на одной машине:

```nginx
iperf -s
```

Сервер будет прослушивать порт 5001 по умолчанию.

2. Запустите клиент на другой машине:

```r
iperf -c server_ip
```

Где `server_ip` — IP-адрес машины, на которой запущен сервер.

3. Посмотрите результаты теста, которые покажут пропускную способность соединения:

```sql
Client connecting to 192.168.1.100, TCP port 5001
TCP window size: 85.0 KByte (default)
[  3] local 192.168.1.200 port 52162 connected with 192.168.1.100 port 5001
[ ID] Interval       Transfer     Bandwidth
[  3]  0.0-10.0 sec   112 MBytes  94.1 Mbits/sec
```

**Расширенные опции iperf:**

- **Тестирование UDP вместо TCP:**
    
    ```r
    iperf -c server_ip -u
    ```
    
    UDP-тесты помогают оценить джиттер (колебания задержки) и потери пакетов.
- **Установка пропускной способности для UDP:**
    
    ```css
    iperf -c server_ip -u -b 100M
    ```
    
    Устанавливает целевую скорость 100 Мбит/с для UDP-теста.
- **Двунаправленный тест:**
    
    ```r
    iperf -c server_ip -d
    ```
    
    Измеряет пропускную способность в обоих направлениях одновременно.
- **Параллельные потоки:**
    
    ```css
    iperf -c server_ip -P 4
    ```
    
    Запускает 4 параллельных потока для более полного использования канала.
- **Изменение размера окна TCP:**
    
    ```r
    iperf -c server_ip -w 256k
    ```
    
    Может повысить производительность на соединениях с высокой задержкой.
- **Непрерывный тест с заданным интервалом:**
    
    ```css
    iperf -c server_ip -t 60 -i 5
    ```
    
    Проводит тест на протяжении 60 секунд с отчётами каждые 5 секунд.

**Различия между iperf и iperf3:**

iperf3 — переписанная версия с некоторыми улучшениями, но она несовместима с оригинальным iperf. Основные различия:

- iperf3 имеет более понятный API и код
- iperf3 позволяет настраивать скорость для TCP-тестов (опция -b)
- iperf3 предоставляет более подробную статистику о CPU-утилизации
- iperf не поддерживает совместное использование с iperf3

Если вам нужны расширенные возможности или более современный инструмент, используйте iperf3. Для совместимости со старыми системами или специфических тестов может понадобиться классический iperf.

### Анализ качества сети с помощью mtr

Утилита `mtr` (My Traceroute) объединяет функциональность `ping` и `traceroute` в интерактивном инструменте, который постоянно обновляет информацию о маршруте и показывает статистику для каждого узла.

**Установка:**

```bash
# Ubuntu/Debian
sudo apt install mtr

# CentOS/RHEL/Fedora
sudo dnf install mtr
```

**Базовое использование:**

```nginx
mtr google.com
```

или

```bash
sudo mtr google.com
```

Запуск с правами root может дать более точные результаты, так как позволяет использовать сырые сокеты.

**Вывод mtr включает:**

- Список всех узлов (маршрутизаторов) на пути к цели
- Количество отправленных пакетов
- Процент потерянных пакетов на каждом узле
- Минимальное, среднее, максимальное время отклика и стандартное отклонение

Эта информация обновляется в реальном времени, что помогает увидеть, как меняется производительность сети.

**Полезные опции mtr:**

- **Текстовый отчёт вместо интерактивного режима:**
    
    ```css
    mtr -r -c 10 google.com
    ```
    
    Генерирует отчёт на основе 10 циклов и завершает работу. Удобно для включения в электронные письма или отчёты.
- **Использование ICMP вместо UDP:**
    
    ```css
    mtr --icmp google.com
    ```
    
    Некоторые устройства могут блокировать UDP-трассировку, но пропускать ICMP.
- **Интервал между пакетами:**
    
    ```css
    mtr -i 0.2 google.com
    ```
    
    Отправляет пакеты каждые 0.2 секунды вместо стандартной 1 секунды.
- **Показ IP-адресов вместо имён хостов:**
    
    ```nginx
    mtr -n google.com
    ```
    
    Ускоряет работу, так как не выполняются DNS-запросы.

**Интерактивные команды в mtr:**

- `d` — переключение между отображением имён хостов и IP-адресов
- `p` — включение/отключение отображения порта
- `n` — сброс всех счётчиков
- `q` — выход из программы

**Интерпретация результатов mtr:**

- **Высокий процент потерь на определённом узле:** Может указывать на проблемы с этим маршрутизатором или соединением до него
- **Резкое увеличение задержки на определённом узле:** Показывает возможное узкое место в сети
- **Стабильно высокое стандартное отклонение:** Признак нестабильного соединения
- **Узлы, не отвечающие на ICMP (****):** Некоторые маршрутизаторы настроены не отвечать на ICMP, это нормально

mtr особенно полезен для долгосрочного мониторинга стабильности соединений и выявления проблемных участков в сети.

### Улучшенные версии утилит ping, traceroute

В Linux существуют расширенные версии стандартных сетевых утилит, которые предлагают дополнительную функциональность для более эффективной диагностики.

#### 1. fping - улучшенная версия ping

В отличие от стандартного `ping`, который отправляет пакеты последовательно, `fping` может отправлять их параллельно нескольким хостам, что значительно ускоряет процесс проверки доступности.

**Установка:**

```bash
# Ubuntu/Debian
sudo apt install fping

# CentOS/RHEL/Fedora
sudo dnf install fping
```

**Ключевые возможности fping:**

- **Ping нескольких хостов одновременно:**
    
    ```nginx
    fping google.com yahoo.com microsoft.com
    ```
    
- **Чтение списка хостов из файла:**
    
    ```nginx
    fping -f hosts.txt
    ```
    
    Где hosts.txt содержит список имён хостов или IP-адресов.
- **Определение живых хостов в подсети:**
    
    ```css
    fping -a -g 192.168.1.0/24
    ```
    
    Опция `-a` показывает только доступные хосты, `-g` задаёт диапазон адресов.
- **Бесконечная отправка с заданным интервалом:**
    
    ```nginx
    fping -l google.com
    ```
    
    Работает как стандартный ping, но с более компактным выводом.

`fping` особенно полезен для администраторов сетей, которым нужно быстро проверить доступность множества устройств.

#### 2. traceroute-nanog - расширенная версия traceroute

Также называемая `tcptraceroute` или `mtr` в некоторых дистрибутивах, эта версия позволяет выполнять трассировку через TCP вместо UDP или ICMP, что помогает обойти ограничения брандмауэров.

**Установка (зависит от дистрибутива):**

```bash
# Ubuntu/Debian
sudo apt install tcptraceroute

# CentOS/RHEL/Fedora - могут использовать пакет traceroute, включающий TCP-трассировку
sudo dnf install traceroute
```

**Ключевые возможности:**

- **Трассировка через TCP на определённый порт:**
    
    ```nginx
    tcptraceroute example.com 80
    ```
    
    Выполняет трассировку до порта 80 (HTTP) на указанном хосте.
- **Указание исходного порта:**
    
    ```nginx
    tcptraceroute -s 53 example.com 80
    ```
    
    Использует порт 53 (DNS) как исходный, что может помочь обойти ограничения брандмауэров.

TCP-трассировка часто работает лучше в современных сетях, где UDP-пакеты часто блокируются или ограничиваются.

### Проверка сетевых служб с помощью netcat

`netcat` (или `nc`) — это универсальный сетевой инструмент, который может выступать как клиент или сервер для TCP/UDP соединений. Его часто называют "швейцарским армейским ножом" для сетевых задач.

**Установка:**

```bash
# Ubuntu/Debian
sudo apt install netcat

# CentOS/RHEL/Fedora
sudo dnf install nc
```

**Основные возможности netcat:**

1. **Проверка доступности порта:**
    
    ```nginx
    nc -zv example.com 80
    ```
    
    Опция `-z` выполняет только проверку соединения без передачи данных, `-v` включает подробный вывод.
2. **Проверка диапазона портов:**
    
    ```nginx
    nc -zv example.com 20-25
    ```
    
    Проверяет порты с 20 по 25 на указанном хосте.
3. **Создание простого сервера:**
    
    ```css
    nc -l -p 1234
    ```
    
    Запускает сервер, прослушивающий порт 1234.
4. **Подключение к серверу:**
    
    ```nginx
    nc example.com 80
    ```
    
    Устанавливает соединение с портом 80 на указанном хосте.
5. **Передача файлов:**
    
    ```yaml
    # На принимающей стороне:
    nc -l -p 1234 > received_file.txt
    
    # На отправляющей стороне:
    nc receiving_host 1234 < file_to_send.txt
    ```
    
6. **Сканирование портов:**
    
    ```nginx
    nc -z -v -w 1 example.com 1-1000
    ```
    
    Проверяет порты с 1 по 1000 с тайм-аутом 1 секунда.

**Практические примеры использования netcat:**

1. **Проверка HTTP-сервера:**
    
    ```swift
    echo -e "GET / HTTP/1.1\r\nHost: example.com\r\n\r\n" | nc example.com 80
    ```
    
    Отправляет простой HTTP-запрос и показывает ответ сервера.
2. **Проверка SMTP-сервера:**
    
    ```nginx
    nc mail.example.com 25
    ```
    
    После соединения можно ввести команды SMTP для проверки функциональности.
3. **Тестирование SSL/TLS:**
    
    ```bash
    echo | openssl s_client -connect example.com:443
    ```
    
    Это использует OpenSSL вместе с netcat для проверки SSL-соединения и показа сертификата.
4. **Создание чата между двумя хостами:**
    
    ```yaml
    # На хосте 1:
    nc -l -p 1234
    
    # На хосте 2:
    nc host1_ip 1234
    ```
    
    Теперь всё, что вводится на одном хосте, будет отображаться на другом.

**Безопасность:** Netcat — мощный инструмент, который может быть использован как для диагностики, так и для взлома. Во многих организациях его использование может быть ограничено политиками безопасности. Используйте его ответственно и только в своих сетях или с явного разрешения.