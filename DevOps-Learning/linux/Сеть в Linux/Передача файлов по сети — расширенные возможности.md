После того как вы освоили базовые инструменты передачи файлов, пришло время изучить более продвинутые возможности, которые используют Linux-администраторы. В этом уроке мы рассмотрим инструменты и приёмы для автоматизации передачи данных, синхронизации директорий, а также работу с высокопроизводительными методами передачи файлов.

### Синхронизация файлов и директорий с `rsync`

**`rsync`** — мощная утилита для синхронизации файлов и папок. Преимущества rsync:

- Инкрементальная синхронизация (копирует только изменённые файлы).
- Передача данных через SSH (защищённое соединение).
- Поддержка сжатия и контрольных сумм.

**Пример использования rsync:**

```ruby
rsync -avz /local/dir user@192.168.1.20:/remote/backup/
```

**Параметры rsync:**

- `-a` — архивный режим (сохраняет права, время, ссылки и рекурсивно копирует директории).
- `-v` — выводить подробную информацию.
- `-z` — использовать сжатие для ускорения передачи данных.
- `--delete` — удалять файлы на целевом сервере, которых нет в источнике (полезно для полной синхронизации).

**Синхронизация с удалением файлов на целевом сервере:**

```ruby
rsync -avz --delete /local/dir user@192.168.1.20:/remote/backup/
```

### Автоматизация передачи файлов через `rsync` и SSH-ключи

Настройка автоматизированного резервного копирования или синхронизации с использованием cron и SSH-ключей:

- Генерируем SSH-ключ (без пароля):

```bash
ssh-keygen -t ed25519 -f ~/.ssh/rsync_key -N ""
```

- Копируем публичный ключ на сервер назначения:

```sql
ssh-copy-id -i ~/.ssh/rsync_key.pub user@192.168.1.20
```

- Добавляем в cron регулярную синхронизацию:

```ruby
crontab -e

# Ежедневно в 02:00
0 2 * * * rsync -az -e "ssh -i ~/.ssh/rsync_key" /local/dir user@192.168.1.20:/remote/backup/
```

### Высокоскоростная передача файлов через `scp` с компрессией

Если нужно быстро передать большие файлы по SSH, используйте встроенное сжатие данных:

```ruby
scp -C largefile.tar.gz user@192.168.1.20:/home/user/
```

- `-C` — включает компрессию при передаче.

### Передача больших файлов с помощью `split` и `cat`

Иногда удобнее разделить большие файлы на части перед передачей, а затем соединить их на стороне получателя.

**Разделение файла перед передачей:**

```bash
split -b 500M largefile.iso part-
```

- Получатся файлы вида `part-aa`, `part-ab` и т.д.

**Передаём файлы (например, через scp):**

```ruby
scp part-* user@192.168.1.20:/home/user/
```

**Объединение файлов на принимающей стороне:**

```bash
cat part-* > largefile.iso
```

### Использование протокола FTP с `lftp`

**`lftp`** — продвинутый FTP-клиент с поддержкой автоматизации, возобновления передач и зеркалирования каталогов.

Установка:

```bash
sudo apt install lftp
```

**Подключение к FTP-серверу:**

```perl
lftp ftp://user:password@ftp.example.com
```

**Зеркалирование удалённого каталога:**

```nginx
mirror remote_dir local_dir
```

**Зеркалирование локального каталога на сервер:**

```css
mirror -R local_dir remote_dir
```

- `-R` — зеркалирование с клиента на сервер.

### Быстрая передача файлов через `rsync daemon` (без SSH)

Для высокоскоростной передачи больших объёмов данных иногда используют rsync в режиме демона.

- Настройка rsync-демона на сервере (`/etc/rsyncd.conf`):

```bash
[backup]
path = /backup
comment = Backup area
read only = no
auth users = backupuser
secrets file = /etc/rsyncd.secrets
```

- Создание файла с паролем (`/etc/rsyncd.secrets`):

```makefile
backupuser:strongpassword
```

- Запуск демона:

```bash
sudo systemctl enable --now rsync
```

- Передача файлов с клиента:

```ruby
rsync -avz --password-file=rsync.pass local_dir backupuser@192.168.1.20::backup/
```

- Файл `rsync.pass` содержит только пароль и должен иметь права `600`.

## Итоги

- `rsync` — мощная утилита для синхронизации и резервного копирования.
- Автоматизация передачи данных осуществляется с помощью SSH-ключей и cron.
- Передача файлов больших размеров удобнее с использованием компрессии (`scp -C`) или разбивки на части (`split`/`cat`).
- `lftp` — удобный клиент для работы с FTP и зеркалирования каталогов.
- Использование rsync-демона позволяет существенно увеличить скорость передачи данных.