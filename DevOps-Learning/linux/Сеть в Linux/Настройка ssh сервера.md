В предыдущем уроке мы рассмотрели основы протокола SSH и его использование. Теперь углубимся в настройку SSH-сервера для обеспечения максимальной безопасности при удаленном доступе к системе. Грамотная настройка SSH-сервера позволяет защитить вашу систему от большинства типов атак и обеспечить контролируемый доступ только авторизованным пользователям.

### Файл конфигурации SSH-сервера (/etc/ssh/sshd_config)

Все настройки SSH-сервера хранятся в файле `/etc/ssh/sshd_config`. Этот файл содержит множество параметров, которые влияют на работу сервера, его безопасность и способы аутентификации.

**Работа с конфигурационным файлом:**

- Всегда создавайте резервную копию перед внесением изменений:
    
    ```bash
    sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
    ```
    
- Используйте текстовый редактор с правами root для редактирования:
    
    ```bash
    sudo nano /etc/ssh/sshd_config
    ```
    
- После внесения изменений перезапустите службу SSH для применения настроек:
    
    ```bash
    sudo systemctl restart sshd
    ```
    
    или на более старых системах:
    
    ```bash
    sudo service ssh restart
    ```
    

**Важное предупреждение:** При изменении настроек SSH-сервера всегда сохраняйте текущую сессию и проверяйте новые настройки, открыв вторую сессию, прежде чем закрывать первую. Это поможет избежать потери доступа к системе в случае ошибки конфигурации.

### Управление параметрами безопасности

#### Отключение корневого входа (PermitRootLogin)

Пользователь root имеет неограниченные права в системе, поэтому разрешение прямого SSH-доступа для root представляет значительную угрозу безопасности. Рекомендуется отключить прямой вход для root и использовать sudo для выполнения административных задач.

Параметр `PermitRootLogin` может принимать несколько значений:

- **yes** — разрешает вход root по паролю и ключу (не рекомендуется)
- **prohibit-password** (или **without-password**) — разрешает вход root только по ключу
- **forced-commands-only** — разрешает вход root только для выполнения предопределенных команд
- **no** — полностью запрещает вход для root (рекомендуется)

Чтобы отключить вход для root, найдите строку с параметром `PermitRootLogin` и установите значение `no`:

```nginx
PermitRootLogin no
```

Если параметр закомментирован (начинается с #), удалите символ # для активации настройки.

#### Использование только ключей (PasswordAuthentication)

Аутентификация по паролю подвержена атакам методом перебора. Использование только SSH-ключей значительно повышает безопасность. После настройки аутентификации по ключам для всех пользователей рекомендуется отключить аутентификацию по паролю.

Для отключения аутентификации по паролю установите:

```nginx
PasswordAuthentication no
```

**Совет:** Перед отключением аутентификации по паролю убедитесь, что:

1. Вы успешно настроили аутентификацию по ключу
2. Вы можете подключиться с использованием этого ключа
3. У вас есть резервный метод доступа в случае проблем (например, консоль сервера)

Другие связанные параметры аутентификации:

- **ChallengeResponseAuthentication no** — отключение аутентификации с запросом-ответом
- **KbdInteractiveAuthentication no** — отключение интерактивной аутентификации с клавиатуры
- **UsePAM yes** — использование модулей PAM для аутентификации (обычно оставляют включенным)

#### Изменение порта по умолчанию

По умолчанию SSH использует порт 22. Изменение порта не повышает криптографическую безопасность, но может защитить от автоматизированных атак и сканеров, которые нацелены на стандартный порт.

Чтобы изменить порт, найдите параметр `Port` и установите нестандартное значение:

```yaml
Port 2222
```

При выборе нового порта учитывайте:

- Не используйте порты ниже 1024 (они требуют привилегий root)
- Избегайте портов, которые могут быть заняты другими службами
- Лучше использовать порты выше 10000 для снижения вероятности конфликтов

После изменения порта все подключения должны указывать новый порт:

```css
ssh -p 2222 user@server
```

**Примечание:** Если на сервере настроен файрвол (например, iptables или firewalld), не забудьте открыть новый порт:

```bash
# Для iptables
sudo iptables -A INPUT -p tcp --dport 2222 -j ACCEPT

# Для firewalld
sudo firewall-cmd --permanent --add-port=2222/tcp
sudo firewall-cmd --reload
```

### Настройка ограничений для пользователей и групп

SSH позволяет ограничить доступ к серверу только определенным пользователям или группам, а также запретить доступ для конкретных пользователей.

#### Разрешение доступа только определенным пользователям

Для ограничения доступа только перечисленным пользователям используйте параметр `AllowUsers`:

```nginx
AllowUsers user1 user2 admin
```

Этот параметр перечисляет пользователей, которым разрешен SSH-доступ. Все остальные пользователи не смогут подключиться, даже если у них есть учетные записи в системе.

#### Разрешение доступа только определенным группам

Аналогично можно ограничить доступ на уровне групп с помощью параметра `AllowGroups`:

```nginx
AllowGroups ssh-users admins developers
```

SSH-доступ будет разрешен только пользователям, входящим в перечисленные группы.

#### Запрет доступа определенным пользователям

Для запрета доступа конкретным пользователям используйте `DenyUsers`:

```nginx
DenyUsers baduser temporaryuser guest
```

#### Запрет доступа определенным группам

Аналогично можно запретить доступ на уровне групп:

```nginx
DenyGroups guests restricted
```

**Порядок применения ограничений:** Параметры применяются в следующем порядке: `DenyUsers`, `AllowUsers`, `DenyGroups`, `AllowGroups`. Если пользователь подпадает под несколько правил, первое из них имеет приоритет.

#### Ограничение доступа через системные группы PAM

Дополнительный уровень ограничений можно настроить через модули PAM:

```bash
sudo nano /etc/security/access.conf
```

```less
+ : sshusers : ALL
- : ALL : ALL
```

```swift
account required pam_access.so
```

1. Отредактируйте файл `/etc/security/access.conf`:
2. Добавьте правила, например:
3. Это разрешает доступ только членам группы "sshusers" и запрещает всем остальным.
4. Убедитесь, что в файле `/etc/pam.d/sshd` есть строка:

### Использование баннеров и приветственных сообщений

SSH позволяет отображать предупреждающие или информационные сообщения при подключении пользователей. Это полезно для предупреждения о мониторинге, юридических последствиях несанкционированного доступа или просто для отображения информации о системе.

#### Настройка баннера перед аутентификацией

Баннер отображается до аутентификации и часто используется для предупреждения о юридических последствиях несанкционированного доступа.

```bash
sudo nano /etc/ssh/banner
```

```markdown
***************************************************************************
                        ВНИМАНИЕ! СЛУЖЕБНАЯ СИСТЕМА
        
    Несанкционированный доступ запрещен и преследуется по закону.
    Все действия в системе записываются и могут быть использованы
    как доказательство в суде.
    
***************************************************************************
```

```bash
Banner /etc/ssh/banner
```

1. Создайте файл с текстом баннера:
2. Добавьте текст баннера, например:
3. Укажите путь к файлу баннера в конфигурации SSH:

#### Настройка приветственного сообщения после аутентификации

Приветственное сообщение (Message of the Day, MOTD) отображается после успешной аутентификации и может содержать информацию о системе, контактные данные администраторов или напоминания для пользователей.

```bash
sudo nano /etc/motd
```

```1c
Добро пожаловать на сервер example.com!

Система предназначена для разработки и тестирования.
Для вопросов и проблем обращайтесь: admin@example.com

Последнее обновление безопасности: 15.05.2023
```

1. Отредактируйте файл `/etc/motd`:
2. Добавьте текст приветствия, например:

В современных системах MOTD может генерироваться динамически скриптами в директории `/etc/update-motd.d/`.

### Настройка тайм-аутов и ограничений на соединения

Правильная настройка тайм-аутов и ограничений на соединения повышает безопасность и эффективность использования ресурсов сервера.

#### Тайм-аут неактивной сессии

Для автоматического отключения бездействующих сессий используйте параметр `ClientAliveInterval` (в секундах):

```nginx
ClientAliveInterval 300
```

Этот параметр указывает, как часто сервер должен отправлять запросы клиенту. Если клиент не отвечает на определенное количество запросов, сессия закрывается:

```nginx
ClientAliveCountMax 3
```

С этими настройками сервер будет отправлять запрос каждые 5 минут (300 секунд) и закроет соединение после 3 неудачных попыток, т.е. через 15 минут бездействия.

#### Тайм-аут аутентификации

Для ограничения времени, отведенного на аутентификацию (ввод пароля или проверку ключа):

```nginx
LoginGraceTime 60
```

Этот параметр устанавливает тайм-аут в 60 секунд — если пользователь не аутентифицируется за это время, соединение закрывается.

#### Ограничение количества попыток аутентификации

Для защиты от атак перебором можно ограничить количество попыток аутентификации для одного соединения:

```nginx
MaxAuthTries 4
```

После 4 неудачных попыток соединение будет закрыто. Обратите внимание, что каждая неудачная попытка с публичным ключом также считается.

#### Ограничение параллельных соединений

Для ограничения количества одновременных соединений от одного пользователя:

```nginx
MaxSessions 10
```

Это ограничивает количество параллельных сессий в рамках одного TCP-соединения.

```nginx
MaxStartups 10:30:100
```

Формат `start:rate:full` означает:

- 10 — максимальное количество соединений без аутентификации
- 30 — процент соединений, которые будут отклонены после достижения лимита
- 100 — абсолютный максимум соединений

### Настройка логирования

Логирование помогает отслеживать попытки входа и активность пользователей, что критически важно для безопасности и аудита.

#### Уровни логирования в SSH

Параметр `LogLevel` определяет, какие события будут записываться в журнал:

```nginx
LogLevel VERBOSE
```

Доступные уровни логирования (от наименее к наиболее подробному):

- **QUIET** — ничего, кроме фатальных ошибок
- **FATAL** — только фатальные ошибки
- **ERROR** — ошибки и фатальные ошибки
- **INFO** — информационные сообщения, ошибки и фатальные ошибки (стандартный уровень)
- **VERBOSE** — полезно для отладки, включает больше деталей
- **DEBUG** — отладка соединений, много информации
- **DEBUG1-3** — уровни для глубокой отладки

Для обычных серверов рекомендуется уровень `VERBOSE`, который предоставляет достаточно информации для аудита без излишних деталей.

#### Расположение логов SSH

Логи SSH обычно записываются в системный журнал (syslog). В зависимости от дистрибутива их можно найти в:

- Ubuntu/Debian: `/var/log/auth.log`
- CentOS/RHEL/Fedora: `/var/log/secure`

Для просмотра логов в реальном времени используйте команду:

```bash
sudo tail -f /var/log/auth.log
```

Или для систем с systemd:

```bash
sudo journalctl -u sshd -f
```

#### Анализ логов SSH

Для поиска неудачных попыток входа:

```bash
sudo grep "Failed password" /var/log/auth.log
```

Для поиска успешных входов:

```bash
sudo grep "Accepted" /var/log/auth.log
```

### Использование утилиты fail2ban для защиты от брутфорса

Fail2ban — это утилита, которая анализирует логи и временно блокирует IP-адреса, с которых происходят многократные неудачные попытки входа. Это эффективная защита от атак методом перебора.

#### Установка fail2ban

На Debian/Ubuntu:

```bash
sudo apt install fail2ban
```

На CentOS/RHEL/Fedora:

```bash
sudo dnf install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

#### Конфигурация fail2ban

Fail2ban использует "тюрьмы" (jails) — наборы правил для различных сервисов. Основная конфигурация находится в `/etc/fail2ban/jail.conf`, но рекомендуется создать файл `/etc/fail2ban/jail.local` для переопределения настроек:

```bash
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo nano /etc/fail2ban/jail.local
```

Базовая настройка для защиты SSH:

```ini
[DEFAULT]
# Время бана в секундах (1 день)
bantime = 86400

# Время в секундах, за которое учитываются неудачные попытки
findtime = 600

# Количество неудачных попыток до бана
maxretry = 3

# Игнорируемые IP-адреса (например, ваш домашний IP)
ignoreip = 127.0.0.1/8 ::1 192.168.1.0/24

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = %(sshd_log)s
backend = %(sshd_backend)s
```

Если вы изменили порт SSH на нестандартный, укажите его в параметре `port`:

```ini
port = 2222
```

После внесения изменений перезапустите fail2ban:

```bash
sudo systemctl restart fail2ban
```

#### Управление fail2ban

Проверка статуса:

```bash
sudo fail2ban-client status
```

Проверка статуса конкретной "тюрьмы":

```bash
sudo fail2ban-client status sshd
```

Разблокировка IP-адреса:

```bash
sudo fail2ban-client set sshd unbanip 192.168.1.100
```

#### Создание собственных правил

Fail2ban позволяет создавать собственные фильтры и действия. Фильтры определяются в директории `/etc/fail2ban/filter.d/`, а действия — в `/etc/fail2ban/action.d/`.

Например, для создания дополнительного фильтра для SSH:

```bash
sudo nano /etc/fail2ban/filter.d/custom-sshd.conf
```

Содержимое файла:

```csharp
[Definition]
failregex = ^%(__prefix_line)sConnection from  port \d+ on \S+ port \d+$
ignoreregex =
```

Затем нужно создать тюрьму в `/etc/fail2ban/jail.local`:

```ini
[custom-sshd]
enabled = true
port = ssh
filter = custom-sshd
logpath = %(sshd_log)s
maxretry = 1
```

### Дополнительные советы по безопасности SSH

#### 1. Использование только современных протоколов и шифров

Ограничение сервера только современными, безопасными протоколами и шифрами:

```nginx
# Разрешить только SSH протокол версии 2
Protocol 2

# Использовать только безопасные шифры
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr

# Использовать только безопасные алгоритмы обмена ключами
KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256

# Использовать только безопасные алгоритмы MAC
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
```

#### 2. Двухфакторная аутентификация

Настройка двухфакторной аутентификации с помощью Google Authenticator:

```bash
sudo apt install libpam-google-authenticator
```

```undefined
google-authenticator
```

```bash
sudo nano /etc/pam.d/sshd
```

```swift
auth required pam_google_authenticator.so
```

```nginx
ChallengeResponseAuthentication yes
AuthenticationMethods publickey,keyboard-interactive
```

```bash
sudo systemctl restart sshd
```

1. Установите пакет:
2. Запустите настройку для своего пользователя:
3. Отредактируйте файл `/etc/pam.d/sshd`:
4. Добавьте строку:
5. Отредактируйте `/etc/ssh/sshd_config`:
6. Перезапустите SSH:

#### 3. Изоляция SSH в chroot

Ограничение пользователей определенной директорией:

```perl
Match Group sftponly
    ChrootDirectory /home/%u
    ForceCommand internal-sftp
    AllowTcpForwarding no
    PermitTunnel no
    X11Forwarding no
```