Настройка сетевых подключений — это только половина работы системного администратора. Вторая, не менее важная часть — умение диагностировать проблемы, когда сеть не работает должным образом. Linux предоставляет богатый набор инструментов для диагностики сетевых проблем, и в этом уроке мы рассмотрим основные из них.

### Утилита ping для проверки доступности хостов

Команда `ping` — это первый и самый базовый инструмент для проверки сетевой связи. Она использует протокол ICMP (Internet Control Message Protocol) для отправки эхо-запросов к удаленному хосту и измерения времени ответа.

**Для чего используется ping:**

- Проверить, доступен ли удаленный хост
- Измерить задержку (латентность) соединения
- Определить стабильность связи (потери пакетов)
- Проверить работоспособность DNS (если используется доменное имя)

**Базовое использование:**

```dos
ping google.com
```

Эта команда отправляет ICMP-пакеты на сервер google.com и показывает результаты:

```python
PING google.com (142.250.185.78) 56(84) bytes of data.
64 bytes from waw02s22-in-f14.1e100.net (142.250.185.78): icmp_seq=1 ttl=115 time=12.3 ms
64 bytes from waw02s22-in-f14.1e100.net (142.250.185.78): icmp_seq=2 ttl=115 time=12.1 ms
64 bytes from waw02s22-in-f14.1e100.net (142.250.185.78): icmp_seq=3 ttl=115 time=12.4 ms
```

В этом выводе мы видим:

- IP-адрес хоста (142.250.185.78) — показывает, что DNS-разрешение работает
- Последовательные номера пакетов (icmp_seq)
- Значение TTL (Time To Live) — указывает, сколько маршрутизаторов может пройти пакет
- Время ответа в миллисекундах (time) — показывает задержку

**Полезные опции ping:**

- `-c` — ограничить количество отправляемых пакетов:
    
    ```r
    ping -c 4 google.com
    ```
    
    Эта команда отправит только 4 пакета и остановится, показав статистику.
- `-i` — изменить интервал между пакетами (в секундах):
    
    ```css
    ping -i 0.2 google.com
    ```
    
    Отправляет пакеты каждые 0.2 секунды вместо стандартной 1 секунды.
- `-s` — изменить размер пакета:
    
    ```yaml
    ping -s 1000 google.com
    ```
    
    Полезно для проверки фрагментации и MTU.

**Интерпретация результатов:**

- **Нормальный результат:** регулярные ответы с низкой и стабильной задержкой
- **Потеря пакетов:** отсутствие ответов на некоторые запросы указывает на проблемы с соединением
- **Большая задержка:** высокие или нестабильные значения времени указывают на перегрузку сети
- **Unknown host:** ошибка разрешения имени, проблема с DNS
- **Network unreachable:** проблема с маршрутизацией

### Трассировка маршрута (traceroute, tracepath)

Если `ping` показывает, что хост недоступен или задержка слишком большая, следующий шаг — выяснить, где именно в сети возникает проблема. Для этого используются инструменты трассировки маршрута.

**Что такое трассировка маршрута:**

Трассировка показывает путь, который проходят пакеты от вашего компьютера до целевого хоста, и время задержки на каждом участке. Это помогает определить, на каком именно маршрутизаторе происходят задержки или потери пакетов.

**Инструменты:**

- `traceroute` — классический инструмент (может требовать установки в некоторых дистрибутивах)
- `tracepath` — более новая версия, обычно предустановлена

**Принцип работы:**

Эти утилиты используют увеличивающееся значение TTL (Time To Live) в IP-пакетах. Когда TTL достигает нуля, маршрутизатор отбрасывает пакет и отправляет обратно ICMP-сообщение об ошибке. Это позволяет определить каждый маршрутизатор на пути и время до него.

**Базовое использование:**

```1c
traceroute google.com

# или

tracepath google.com
```

Пример вывода:

```nginx
traceroute to google.com (142.250.185.78), 30 hops max, 60 byte packets
 1  _gateway (192.168.1.1)  0.283 ms  0.340 ms  0.378 ms
 2  78-30-201-1.staticip.zebra.lt (78.30.201.1)  11.553 ms  11.662 ms  11.712 ms
 3  9.110.227.212.static.zebra.lt (212.227.110.9)  12.004 ms  12.069 ms  12.117 ms
 4  10ge10-3.core1.fra3.he.net (195.69.147.89)  32.865 ms  32.908 ms  32.959 ms
 5  100ge9-2.core1.ams1.he.net (184.105.64.22)  39.644 ms  39.658 ms  39.705 ms
 6  * * *
 7  142.250.185.78 (142.250.185.78)  40.333 ms  40.375 ms  40.427 ms
```

В этом выводе каждая строка представляет один "прыжок" (hop) в маршруте:

- Номер прыжка (от 1 до N)
- Имя хоста и IP-адрес маршрутизатора
- Время ответа для трех последовательных попыток
- Звездочки (*) означают отсутствие ответа от маршрутизатора

**Интерпретация результатов:**

- **Нормальный маршрут:** последовательное увеличение задержки с разумными значениями
- **Значительный скачок времени:** указывает на медленный участок сети
- **Множественные звездочки (*):** маршрутизатор не отвечает на ICMP (часто из соображений безопасности)
- **Звездочки в конце маршрута:** возможно, целевой хост блокирует ICMP
- **Циклические маршруты:** повторяющиеся узлы указывают на петлю маршрутизации

**Разница между traceroute и tracepath:**

- `traceroute` более гибкий и имеет больше опций (может использовать UDP, ICMP или TCP)
- `tracepath` проще, но автоматически определяет MTU (Maximum Transmission Unit) пути

### Сканирование портов с помощью nmap

Если хост доступен по ping и трассировка показывает нормальный маршрут, но какой-то сервис (например, веб-сервер) не отвечает, следующий шаг — проверить, открыт ли соответствующий порт. Для этого используется `nmap` (Network Mapper).

**Что такое nmap:**

Nmap — это мощный инструмент для сканирования сети, который позволяет определить, какие порты на хосте открыты, какие сервисы работают, и даже выявить некоторые уязвимости. В контексте диагностики он помогает понять, доступен ли нужный порт и работает ли на нем ожидаемый сервис.

**Установка nmap:**

В большинстве дистрибутивов nmap нужно устанавливать отдельно:

```bash
# Ubuntu/Debian
sudo apt install nmap

# CentOS/RHEL/Fedora
sudo dnf install nmap
```

**Базовое сканирование:**

```nginx
nmap example.com
```

Эта команда проверит наиболее распространенные 1000 портов на хосте example.com. Пример вывода:

```bash
Starting Nmap 7.80 ( https://nmap.org ) at 2023-10-15 12:34 CEST
Nmap scan report for example.com (93.184.216.34)
Host is up (0.12s latency).
Not shown: 998 filtered ports
PORT    STATE SERVICE
80/tcp  open  http
443/tcp open  https

Nmap done: 1 IP address (1 host) scanned in 8.72 seconds
```

Этот результат показывает, что на хосте открыты только порты 80 (HTTP) и 443 (HTTPS), а остальные порты отфильтрованы (возможно, брандмауэром).

**Сканирование конкретных портов:**

```css
nmap -p 22,80,443,3306 example.com
```

Эта команда проверит только указанные порты (SSH, HTTP, HTTPS и MySQL).

**Полезные опции nmap:**

- `-p-` — сканировать все 65535 портов
- `-sV` — определить версии служб на открытых портах:
    
    ```css
    nmap -sV -p 22,80 example.com
    ```
    
- `-F` — быстрое сканирование (только наиболее распространенные порты)
- `-T0` до `-T5` — установка скорости сканирования (T0 самый медленный, T5 самый быстрый):
    
    ```nginx
    nmap -T4 example.com
    ```
    

**Важно:** Nmap — мощный инструмент, который может восприниматься как попытка взлома. Используйте его только для сканирования собственных систем или с явного разрешения владельца. Несанкционированное сканирование чужих систем может быть незаконным в некоторых юрисдикциях.

### Анализ DNS с помощью dig, host и nslookup

Проблемы с DNS (Domain Name System) — одна из наиболее распространенных причин сетевых неполадок. Linux предоставляет несколько инструментов для проверки и диагностики DNS.

**Инструменты для анализа DNS:**

- `dig` (Domain Information Groper) — мощный и гибкий инструмент для запросов DNS
- `host` — простой инструмент для быстрых проверок
- `nslookup` — интерактивный инструмент, доступный на большинстве платформ

#### 1. Утилита dig

`dig` предоставляет наиболее подробную информацию и гибкие возможности для запросов DNS. Многие администраторы предпочитают его для диагностики.

**Базовый запрос:**

```nginx
dig example.com
```

Эта команда выполнит стандартный запрос A-записи (IPv4-адрес) для домена example.com. Вывод включает заголовок запроса, раздел вопроса, раздел ответа, дополнительную информацию и статистику.

**Запрос определенного типа записи:**

```nginx
dig example.com MX
```

Запрашивает записи MX (почтовые серверы) для домена.

**Запрос к конкретному DNS-серверу:**

```nginx
dig @8.8.8.8 example.com
```

Отправляет запрос к DNS-серверу Google (8.8.8.8) вместо настроенного по умолчанию.

**Трассировка DNS:**

```nginx
dig +trace example.com
```

Выполняет полную трассировку процесса разрешения имени, начиная с корневых серверов DNS.

**Обратный поиск (IP в имя):**

```nginx
dig -x 8.8.8.8
```

Выполняет обратный поиск — определяет имя хоста по IP-адресу.

#### 2. Утилита host

`host` предлагает более простой и понятный вывод для базовых запросов DNS.

**Базовый запрос:**

```nginx
host example.com
```

Показывает IPv4 и IPv6 адреса, а также записи MX для домена.

**Запрос определенного типа записи:**

```nginx
host -t NS example.com
```

Запрашивает серверы имен (NS) для домена.

**Обратный поиск:**

```nginx
host 8.8.8.8
```

Выполняет обратный поиск IP-адреса.

#### 3. Утилита nslookup

`nslookup` может работать как в интерактивном режиме, так и в режиме командной строки.

**Базовый запрос:**

```nginx
nslookup example.com
```

Показывает имя и IP-адрес сервера, а также результат запроса.

**Интерактивный режим:**

```shell
nslookup
> server 8.8.8.8
> set type=MX
> example.com
> exit
```

В интерактивном режиме можно выполнить несколько запросов, меняя параметры между ними.

**Выбор инструмента DNS:**

- **dig** — для подробного анализа и скриптов
- **host** — для быстрых проверок и человекочитаемого вывода
- **nslookup** — для интерактивной работы и совместимости с другими системами

### Отображение сетевых соединений с помощью netstat и ss

Для проверки активных соединений, прослушиваемых портов и статистики сети в Linux используются утилиты `netstat` и `ss`.

#### 1. Утилита netstat

`netstat` — традиционный инструмент для отображения сетевых соединений, таблиц маршрутизации и статистики интерфейсов. Хотя он считается устаревшим, многие администраторы до сих пор его используют из-за привычки.

**Основные команды netstat:**

- **Просмотр всех соединений:**
    
    ```css
    netstat -a
    ```
    
    Показывает все соединения и порты (как TCP, так и UDP).
- **Просмотр только TCP-соединений:**
    
    ```iecst
    netstat -at
    ```
    
- **Просмотр только прослушиваемых портов:**
    
    ```nginx
    netstat -ltn
    ```
    
    Опция `-l` показывает только прослушиваемые порты, `-t` ограничивает вывод TCP-соединениями, `-n` отображает IP-адреса и порты числами (без разрешения имен).
- **Просмотр статистики интерфейсов:**
    
    ```css
    netstat -i
    ```
    
    Показывает базовую статистику для сетевых интерфейсов (пакеты, ошибки).
- **Просмотр программ, использующих соединения:**
    
    ```css
    netstat -p
    ```
    
    Показывает PID и имя процесса для каждого соединения (требует прав root).

**Пример вывода netstat -tuln:**

```nginx
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN     
tcp6       0      0 :::22                   :::*                    LISTEN     
tcp6       0      0 ::1:631                 :::*                    LISTEN     
udp        0      0 0.0.0.0:68              0.0.0.0:*                          
```

В этом выводе мы видим:

- SSH-сервер (порт 22) прослушивает все интерфейсы (0.0.0.0 и :::)
- CUPS (порт 631) прослушивает только локальный интерфейс (127.0.0.1 и ::1)
- DHCP-клиент (порт 68) использует UDP

#### 2. Утилита ss

`ss` (Socket Statistics) — более новая и эффективная замена `netstat`. Она отображает ту же информацию, но работает быстрее, особенно на системах с большим количеством соединений.

**Основные команды ss:**

- **Просмотр всех соединений:**
    
    ```css
    ss -a
    ```
    
- **Просмотр только TCP-соединений:**
    
    ```nginx
    ss -t
    ```
    
- **Просмотр только прослушиваемых портов:**
    
    ```nginx
    ss -ltn
    ```
    
- **Просмотр установленных соединений:**
    
    ```perl
    ss -o state established
    ```
    
    Показывает только активные соединения с информацией о времени.
- **Просмотр соединений с конкретным адресом или портом:**
    
    ```nginx
    ss -t dst 192.168.1.1
    ss -t dport = :22
    ```
    
    Фильтрация по адресу назначения или порту.

**Пример вывода ss -tuln:**

```ruby
Netid  State    Recv-Q   Send-Q      Local Address:Port      Peer Address:Port                                                                                                
udp    UNCONN   0        0                 0.0.0.0:68             0.0.0.0:*                                                                                                    
tcp    LISTEN   0        128               0.0.0.0:22             0.0.0.0:*                                                                                                    
tcp    LISTEN   0        5               127.0.0.1:631            0.0.0.0:*                                                                                                    
tcp    LISTEN   0        128                  [::]:22                [::]:*                                                                                                    
tcp    LISTEN   0        5                   [::1]:631               [::]:*
```

Вывод очень похож на `netstat`, но `ss` обычно предоставляет более подробную информацию о состоянии сокетов и быстрее работает.

### Мониторинг сетевых соединений в реальном времени

Для наблюдения за сетевой активностью в реальном времени можно использовать несколько инструментов мониторинга.

#### 1. Утилита watch

Команда `watch` позволяет периодически выполнять другие команды, обновляя их вывод. Это простой способ мониторить сетевые соединения в реальном времени:

```nginx
watch -n 1 'ss -t'
```

Эта команда будет обновлять список TCP-соединений каждую секунду.

#### 2. Утилита iftop

`iftop` отображает использование пропускной способности по хостам в реальном времени, показывая, какие соединения потребляют наибольшую часть канала:

```bash
sudo iftop -i eth0
```

`iftop` обычно требует установки:

```bash
# Ubuntu/Debian
sudo apt install iftop

# CentOS/RHEL/Fedora
sudo dnf install iftop
```

#### 3. Утилита nethogs

`nethogs` показывает использование пропускной способности по процессам, что помогает определить, какое приложение потребляет сетевой трафик:

```bash
sudo nethogs eth0
```

Также требует установки:

```bash
# Ubuntu/Debian
sudo apt install nethogs

# CentOS/RHEL/Fedora
sudo dnf install nethogs
```

#### 4. Утилита tcpdump

`tcpdump` — мощный инструмент для анализа сетевого трафика на уровне пакетов. Он позволяет наблюдать и фильтровать пакеты в реальном времени:

```bash
sudo tcpdump -i eth0 host example.com
```

Эта команда отображает все пакеты, отправляемые на или получаемые от example.com через интерфейс eth0.

Более подробно `tcpdump` и другие продвинутые инструменты будут рассмотрены в следующем уроке.

## Итоги

- `ping` — базовый инструмент для проверки доступности хостов и качества соединения
- `traceroute` и `tracepath` помогают визуализировать маршрут пакетов и выявить проблемные участки
- `nmap` — мощный инструмент для сканирования портов и обнаружения служб
- `dig`, `host` и `nslookup` предоставляют разные способы диагностики проблем с DNS
- `netstat` и `ss` показывают активные соединения и прослушиваемые порты
- Инструменты мониторинга в реальном времени позволяют наблюдать за сетевой активностью и выявлять аномалии