В этом уроке мы рассмотрим расширенные возможности, которые позволят вам гибко настраивать сетевую инфраструктуру для решения различных задач.

### Настройка нескольких IP-адресов на одном интерфейсе

В Linux один физический сетевой интерфейс может иметь несколько IP-адресов одновременно. Это может быть полезно в нескольких случаях:

- Хостинг нескольких веб-сайтов на одном сервере (разные IP для разных доменов)
- Миграция сервисов с одного IP-адреса на другой без простоя
- Доступ к нескольким подсетям через один физический интерфейс

Чтобы добавить второй IP-адрес к интерфейсу, используется команда:

```nginx
ip addr add 192.168.1.101/24 dev eth0
```

Эта команда добавляет IP-адрес 192.168.1.101 с маской сети /24 (255.255.255.0) к существующему интерфейсу eth0, не удаляя уже назначенные адреса. Linux автоматически создаёт нужные записи в таблице маршрутизации.

Вы можете добавить даже адрес из другой подсети:

```nginx
ip addr add 10.0.0.5/24 dev eth0
```

Теперь ваш интерфейс доступен в обеих сетях (192.168.1.0/24 и 10.0.0.0/24) без дополнительного оборудования.

### Работа с таблицей маршрутизации (статические маршруты)

Таблица маршрутизации определяет, куда Linux должен отправлять сетевые пакеты. По умолчанию система создаёт маршруты для напрямую подключенных сетей и маршрут по умолчанию (default route). Однако часто требуется создать дополнительные маршруты для доступа к удалённым сетям.

**Почему это важно:** Представьте, что ваш сервер подключен к двум сетям, и вам нужно направить трафик к определённой подсети через конкретный шлюз. Для этого используются статические маршруты.

Пример добавления маршрута к сети 10.0.0.0/8 через шлюз 192.168.1.254:

```nginx
ip route add 10.0.0.0/8 via 192.168.1.254
```

Эта команда говорит: "Для доступа к любому адресу в сети 10.0.0.0/8 отправляй пакеты на маршрутизатор с адресом 192.168.1.254".

> **Мини-шпаргалка маршрутов:**
> 
> - Показать маршруты: `ip route show`
>     
> - Добавить маршрут к сети: `sudo ip route add 10.0.0.0/8 via 192.168.1.254`
>     
> - Удалить маршрут: `sudo ip route del 10.0.0.0/8`
>     

### Настройка параметров сетевого интерфейса (MTU, MAC)

#### Изменение MTU

MTU (Maximum Transmission Unit) определяет максимальный размер пакета, который может быть отправлен через интерфейс без фрагментации. Стандартное значение для Ethernet — 1500 байт.

**Когда нужно менять MTU:**

- **Уменьшение MTU** (например, до 1400) может потребоваться при работе через VPN или в туннелях, где часть пакета используется для дополнительных заголовков
- **Увеличение MTU** (до 9000 — так называемые Jumbo Frames) может ускорить передачу больших файлов в локальной сети, если всё оборудование поддерживает такой размер пакетов

Для изменения MTU используется команда:

```bash
ip link set dev eth0 mtu 1400
```

Неправильное значение MTU может привести к фрагментации пакетов или их потере, поэтому изменяйте этот параметр осторожно.

#### Изменение MAC-адреса

MAC-адрес (Media Access Control) — уникальный физический адрес сетевой карты. В некоторых случаях может потребоваться его изменение:

- Для обхода ограничений провайдера, привязанных к MAC
- При тестировании сетевой безопасности
- При замене сетевой карты, когда нужно сохранить прежний MAC

Чтобы изменить MAC-адрес:

```bash
ip link set dev eth0 address 00:11:22:33:44:55
```

После изменения MAC-адреса необходимо перезапустить интерфейс, отключив и включив его:

```bash
ip link set dev eth0 down
ip link set dev eth0 up
```

### Настройка метрики маршрутов

Метрика — числовое значение, определяющее "стоимость" или предпочтительность маршрута. Маршруты с меньшей метрикой имеют приоритет.

**Практический пример:** Представьте, что у вас есть два подключения к интернету — основное (быстрое) и резервное (медленное). Вы хотите, чтобы система использовала резервное только при недоступности основного.

Настройка выглядит так:

```csharp
# Основной маршрут (приоритетный)
ip route add default via 192.168.1.1 dev eth0 metric 100

# Резервный маршрут (используется при недоступности основного)
ip route add default via 192.168.2.1 dev eth1 metric 200
```

Система будет отправлять пакеты через основной маршрут (192.168.1.1), пока он доступен. Если этот маршрут станет недоступен, пакеты автоматически пойдут через резервный (192.168.2.1).

### ARP-таблица и работа с ней

ARP (Address Resolution Protocol) необходим для связи между IP-адресами и MAC-адресами в локальной сети. Система хранит таблицу соответствий, чтобы не делать запросы при каждой отправке пакета.

**Что такое ARP-таблица:** Это кеш, который хранит соответствие "IP-адрес — MAC-адрес" для узлов в локальной сети. Когда компьютер хочет отправить пакет на определённый IP, он сначала проверяет ARP-таблицу, чтобы найти MAC-адрес получателя.

Для просмотра ARP-таблицы используется команда:

```sql
ip neigh show
```

Вы увидите список IP-адресов, их MAC-адресов и состояний (например, REACHABLE означает, что узел доступен).

Иногда требуется очистить ARP-кеш, например, при изменении сетевой конфигурации или для диагностики проблем:

```lua
ip neigh flush dev eth0
```

Эта команда удаляет все записи ARP для указанного интерфейса, вынуждая систему заново определять MAC-адреса при общении с узлами.

### Настройка алиасов интерфейсов

Алиасы интерфейсов — исторический способ добавления нескольких IP-адресов к одному интерфейсу. В современных системах рекомендуется использовать прямое добавление IP-адресов без алиасов, но иногда старые программы могут ожидать наличия интерфейсов с именами вида eth0:0.

**Что такое алиас интерфейса:** Это логическое имя, присвоенное дополнительной конфигурации IP на одном физическом интерфейсе. Например, eth0:0 — первый алиас для eth0.

В современном синтаксисе можно создать алиас так:

```nginx
ip addr add 192.168.1.101/24 dev eth0 label eth0:0
```

Параметр `label` добавляет метку, делая адрес видимым как алиас при использовании старых инструментов вроде ifconfig.

### Настройка сетевого моста (bridge)

Сетевой мост — это виртуальный интерфейс, объединяющий несколько физических или виртуальных интерфейсов в одну сеть.

**Для чего это нужно:** Представьте, что на одном физическом сервере работает несколько виртуальных машин, и всем им нужен прямой доступ к локальной сети, как если бы они были отдельными физическими компьютерами. Мост решает эту задачу.

Процесс создания моста состоит из нескольких шагов:

1. **Создание интерфейса моста:**
    
    ```bash
    ip link add name br0 type bridge
    ```
    
    Эта команда создаёт виртуальный интерфейс типа "мост" с именем br0.
2. **Добавление реального интерфейса в мост:**
    
    ```bash
    ip link set dev eth0 master br0
    ```
    
    Теперь eth0 работает как часть моста br0, передавая через себя весь трафик.
3. **Настройка IP-адреса на мосту:**
    
    ```nginx
    ip addr add 192.168.1.100/24 dev br0
    ```
    
    IP-адрес назначается мосту, а не физическому интерфейсу.
4. **Активация интерфейсов:**
    
    ```bash
    ip link set dev eth0 up
    ip link set dev br0 up
    ```
    

После такой настройки трафик через eth0 будет проходить через мост br0, что позволяет, например, виртуальным машинам взаимодействовать как непосредственно с физической сетью, так и между собой.

### Виртуальные интерфейсы

Linux поддерживает различные типы виртуальных интерфейсов для специализированных сетевых задач.

#### VLAN интерфейсы

**Что такое VLAN:** Virtual LAN позволяет создать несколько изолированных логических сетей на одной физической инфраструктуре. Это как разделение большого офиса на отдельные отсеки с помощью перегородок.

Для создания VLAN-интерфейса:

```bash
ip link add link eth0 name eth0.10 type vlan id 10
```

Эта команда создаёт виртуальный интерфейс eth0.10, который принимает только пакеты с тегом VLAN ID 10, проходящие через физический интерфейс eth0. Таким образом, вы можете настроить разные подсети для разных отделов компании на одной и той же физической сети.

#### Туннельные интерфейсы

**Зачем нужны туннели:** Представьте, что вам нужно безопасно соединить две удалённые сети через публичный интернет. Туннельные интерфейсы инкапсулируют пакеты одного протокола внутрь пакетов другого протокола.

Пример создания GRE-туннеля для соединения двух сетей:

```nginx
ip tunnel add tun0 mode gre remote 203.0.113.10 local 203.0.113.1
```

Эта команда создаёт туннельный интерфейс tun0, который инкапсулирует пакеты с локального IP 203.0.113.1 для доставки на удалённый конец туннеля с IP 203.0.113.10.

#### Интерфейсы типа dummy

**Для чего нужны dummy-интерфейсы:** Они существуют только в программном виде и не связаны с реальным железом. Полезны для тестирования, создания постоянных IP-адресов, не привязанных к физической сети, или как точка привязки для других виртуальных интерфейсов.

```bash
ip link add dummy0 type dummy
```

После создания такого интерфейса вы можете назначить ему IP-адрес и работать с ним, как с обычным интерфейсом, но трафик через него физически отправляться не будет.

> ### ⚠️ Не путайте
> 
> - MTU/ MAC/ состояние (UP/DOWN) меняем/смотрим через `ip link …`.
>     
> - IP-адреса/ метки (label) — через `ip addr …`.
>     
> - Маршруты/ метрики — через `ip route …`.
>     
> - ARP — это `ip neigh …`, не `ip addr` и не `ip link`.
>     

В следующем уроке мы рассмотрим, как сделать эти настройки постоянными с помощью различных конфигурационных файлов в разных дистрибутивах Linux.