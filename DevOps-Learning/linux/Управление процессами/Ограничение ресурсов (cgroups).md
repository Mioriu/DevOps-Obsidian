## ![](https://ucarecdn.stepik.net/b304258f-c738-4700-92ed-22fb8ea5f7fb/)

–í Linux —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –º–æ—â–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è¬†**Control Groups (cgroups)**. –° –ø–æ–º–æ—â—å—é cgroups –≤—ã –º–æ–∂–µ—Ç–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, –ø–∞–º—è—Ç–∏, –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞ –∏ —Å–µ—Ç–∏, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã —Å–∏—Å—Ç–µ–º—ã.

## –ß—Ç–æ —Ç–∞–∫–æ–µ cgroups?

**Control Groups (cgroups)**¬†‚Äî —ç—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ —è–¥—Ä–æ Linux –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, –≤—ã–¥–µ–ª—è–µ–º—ã—Ö –≥—Ä—É–ø–ø–∞–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –° –ø–æ–º–æ—â—å—é cgroups –º–æ–∂–Ω–æ:

- –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –∏ –ø–∞–º—è—Ç–∏;
- –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Å–∫–∞–º –∏ —Å–µ—Ç–∏;
- –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ –∑–∞–¥–∞—á–∞–º –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º;
- –∑–∞—â–∏—â–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –æ—Ç —á—Ä–µ–∑–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

–ò–º–µ–Ω–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è cgroups —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–∞–∫–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∫–∞–∫ Docker –∏ Kubernetes.

## –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω—ã cgroups

–í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ Linux –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ö–∞–Ω–∏–∑–º¬†**cgroups v2**. –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ cgroups –æ–±—ã—á–Ω–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:

```bash
/sys/fs/cgroup
```

–≠—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∏–µ—Ä–∞—Ä—Ö–∏—é, –≥–¥–µ –∫–∞–∂–¥–∞—è –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π cgroup-–≥—Ä—É–ø–ø–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

> **–ú–∏–Ω–∏-—à–ø–∞—Ä–≥–∞–ª–∫–∞ —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏:**¬†
> 
> - `cpu.max`¬†‚Äî –ª–∏–º–∏—Ç CPU
> - `memory.max`¬†‚Äî –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏
>     
> - `cgroup.procs`¬†‚Äî —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
>     
> - `memory.current`¬†‚Äî —Ç–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
>     

## ![](https://ucarecdn.stepik.net/68d765e5-b40a-4bd2-b645-5cd008cbdb13/)

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞—Ç—å cgroup, –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–µ—ë –ø—Ä–æ—Ü–µ—Å—Å.

### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π cgroup-–≥—Ä—É–ø–ø—ã

–°–æ–∑–¥–∞–¥–∏–º –≥—Ä—É–ø–ø—É¬†`limited_group`¬†–¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è CPU –∏ –ø–∞–º—è—Ç–∏:

```bash
sudo mkdir /sys/fs/cgroup/limited_group
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ CPU

–î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∞–π–ª—ã¬†`cpu.max`. –ù–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≥—Ä—É–ø–ø—É –¥–æ 20% CPU:

```bash
echo "20000 100000" | sudo tee /sys/fs/cgroup/limited_group/cpu.max
```

–ó–¥–µ—Å—å:

- `20000`¬†‚Äî –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥–∞—Ö).
- `100000`¬†‚Äî –ø–µ—Ä–∏–æ–¥ –∏–∑–º–µ—Ä–µ–Ω–∏—è (100000 –º–∫—Å = 0.1 —Å–µ–∫).
- –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≥—Ä—É–ø–ø–∞ –ø–æ–ª—É—á–∞–µ—Ç 20% CPU.

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

–û–≥—Ä–∞–Ω–∏—á–∏–º –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 500 –ú–ë:

```bash
echo $((500*1024*1024)) | sudo tee /sys/fs/cgroup/limited_group/memory.max
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ cgroup

–¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏–º –ø—Ä–æ—Ü–µ—Å—Å –∏ –¥–æ–±–∞–≤–∏–º –µ–≥–æ –≤ –Ω–∞—à—É –≥—Ä—É–ø–ø—É:

```bash
sleep 300 &
echo $! | sudo tee /sys/fs/cgroup/limited_group/cgroup.procs
```

`$!`¬†‚Äî —ç—Ç–æ PID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ¬†`sleep 300`).

–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Ü–µ—Å—Å –±—É–¥–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –Ω–∞–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ systemd –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è cgroups

Systemd —É–ø—Ä–æ—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å cgroups. –í–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å cgroups —á–µ—Ä–µ–∑ —é–Ω–∏—Ç—ã systemd.

–°–æ–∑–¥–∞–¥–∏–º systemd-—é–Ω–∏—Ç –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤:

```bash
sudo vim /etc/systemd/system/myservice.service
```

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:

```ini
[Unit]
Description=My limited service

[Service]
ExecStart=/usr/bin/sleep 300
CPUQuota=20%
MemoryMax=500M

[Install]
WantedBy=multi-user.target
```

–ó–∞—Ç–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ systemd –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å:

```bash
sudo systemctl daemon-reload
sudo systemctl start myservice.service
```

–ü—Ä–æ—Ü–µ—Å—Å –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ —Ä–µ—Å—É—Ä—Å–æ–≤.

üëâ¬†_–ï—Å–ª–∏ –≤—Ä—É—á–Ω—É—é —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ—É–¥–æ–±–Ω–æ, —Ç–æ systemd —É–º–µ–µ—Ç –¥–µ–ª–∞—Ç—å –≤—Å—ë —Ç–æ –∂–µ —Å–∞–º–æ–µ —á–µ—Ä–µ–∑ —é–Ω–∏—Ç—ã. –≠—Ç–æ –∫–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫._

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ cgroups

–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ cgroup:

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏:
    
    ```bash
    cat /sys/fs/cgroup/limited_group/memory.current
    ```
    
- –¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU:
    
    ```bash
    cat /sys/fs/cgroup/limited_group/cpu.stat
    ```
    

### –£–¥–∞–ª–µ–Ω–∏–µ cgroup

–ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –Ω–µ–π –Ω–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:
    
    ```bash
    cat /sys/fs/cgroup/limited_group/cgroup.procs
    ```
    
2. –£–¥–∞–ª–∏—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:
    
    ```bash
    sudo rmdir /sys/fs/cgroup/limited_group
    ```
    

## –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è cgroups

- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á (–±—ç–∫–∞–ø—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö).
- –ò–∑–æ–ª—è—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö).
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–æ–∫ –∏ –æ—Ç–∫–∞–∑–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.
- –†–∞–±–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (Docker, Kubernetes –∏ —Ç.–¥.).