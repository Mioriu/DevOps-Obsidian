Сегодня изучал и практиковался в настройке ssh сервера, а именно в различных параметрах в конфиге /etc/ssh/sshd_config.
Рекомендуется всегда перед его изменением делать бэкап cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak, т.к. могут поломаться настройки подключения к серверу
Еще узнал что в новых системах ssh сервер управляется сокетом systemctl status ssh.socket, т.е. ssh.service triggered by ssh.socket и для корректного применения конфига их оба необходимо перезапустить(можно еще systemctl daemon-reload)
В конфиге есть куча параметров для настройки ssh сервера, их названия интуитивно понятны, можно запрещать вход определенным группам/юзерам, разрешать вход определенным группам/юзерам, выставлять таймауты подключений, количество попыток входа, время жизни неактивной сессии, из интересного можно установить баннер с сообщением на вход с помощью параметра Banner "путь к баннеру", например
Banner /etc/ssh/banner
Можно менять порт по умолчанию для защиты от автоматизированных атак(по умолчанию на 22й порт)
Можно запрещать вход root юзеру
Запрещать вход по паролям, т.е. остается только по ssh ключам
Можно добавить двухфакторную аутентификацию например через google authentificator
Можно ограничивать количество параллельных соединений
С помощью утилиты fail2ban можно настраивать различные политики безопасности по подключению к ssh серверу. Она работает как служба systemd, основана на принципе тюрем, /etc/fail2ban/jail.conf, можно создавать свой файл \*/jail.local в котором можно прописать свои настройки, например:

```ini
[DEFAULT]
# Время бана в секундах (1 день)
bantime = 86400

# Время в секундах, за которое учитываются неудачные попытки
findtime = 600

# Количество неудачных попыток до бана
maxretry = 3

# Игнорируемые IP-адреса (например, ваш домашний IP)
ignoreip = 127.0.0.1/8 ::1 192.168.1.0/24

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = %(sshd_log)s
backend = %(sshd_backend)s
```

в целом эта утилита довольно тонко настраивается

Практика 
#### Задание

Выполните настройку SSH-сервера для повышения безопасности:

1. Отредактируйте конфигурационный файл SSH-сервера:
    - Измените порт SSH с 22 на другой (например, 2222)
    - Отключите вход для пользователя root
    - Отключите аутентификацию по паролю (используйте только ключи)
    - Настройте список разрешенных пользователей
2. Создайте и настройте баннер для предупреждения перед входом в систему
3. Настройте параметры тайм-аутов:
    - Установите тайм-аут неактивной сессии (ClientAliveInterval)
    - Ограничьте количество попыток аутентификации (MaxAuthTries)
4. Установите и настройте fail2ban для защиты от брутфорса
5. Проверьте конфигурацию на наличие ошибок
6. Перезапустите SSH-сервер для применения изменений

Выполните все шаги задания и введите в поле ответа список использованных команд и внесенных изменений.

**Важное предупреждение:** При выполнении этого задания необходимо соблюдать особую осторожность. Ошибки в конфигурации SSH могут привести к потере доступа к системе. Рекомендуется:

- Выполнять задание на тестовой системе или виртуальной машине
- Иметь доступ к консоли системы в случае ошибки конфигурации
- Сохранить активную SSH-сессию и проверять новые настройки через дополнительную сессию
- Создать резервную копию конфигурационного файла перед его изменением

Решение:
Настройки в /etc/ssh/sshd_config
Port 22222
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AllowUsers testuser1 testuser2
Banner /etc/ssh/banner
ClientAliveInterval 300
ClientAliveCountMax 3
MaxAuthTries 5

Установка fail2ban
sudo apt install fail2ban -y
прописал те же настройки в файл что и в уроке
sudo nano /etc/fail2ban/jail.local
проверка статуса тюрьмы
sudo fail2ban-client status
проверка sshd_config на наличие ошибок
sshd -t
Полный перезапуск служб для применение конфига
systemctl daemon-reload
systemctl stop ssh.service
systemctl stop ssh.socket
systemctl start ssh.socket
systemctl start ssh.service
[[Настройка ssh сервера]]

